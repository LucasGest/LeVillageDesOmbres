<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8" />
		<title>Chat Loup Garou</title>

		<link rel="stylesheet" href="css/style.css" />
	</head>
	<body>
		<h1>ðŸŽ² Loup Garou - Chat & Joueurs</h1>

		<div>
			<label>Pseudo :</label>
			<input type="text" id="username" placeholder="Ton pseudo" />
			<button onclick="createGame()">CrÃ©er une partie</button>
			<input type="text" id="roomInput" placeholder="Code de partie" />
			<button onclick="joinGame()">Rejoindre</button>
		</div>

		<div id="roomInfo"></div>

		<h3>ðŸ‘¥ Joueurs connectÃ©s</h3>
		<div id="players"></div>

		<h3>ðŸ’¬ Chat</h3>
		<div id="chat"></div>
		<input type="text" id="message" placeholder="Ã‰cris ton message" />
		<button onclick="sendMessage()">Envoyer</button>
		<button onclick="debugPlayers()">ðŸ“‹ Voir joueurs en console</button>

		<script type="module">
			import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
			import {
				getDatabase,
				ref,
				push,
				set,
				onValue,
				onChildAdded,
				remove,
			} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

			const firebaseConfig = {
				apiKey: "AIzaSyA181_gZwR6YfqhFiZkJ7IZKVSi9Qn1A8s",
				authDomain: "loup-garou-b0b31.firebaseapp.com",
				databaseURL:
					"https://loup-garou-b0b31-default-rtdb.europe-west1.firebasedatabase.app",
				projectId: "loup-garou-b0b31",
				storageBucket: "loup-garou-b0b31.firebasestorage.app",
				messagingSenderId: "559349895784",
				appId: "1:559349895784:web:0caac5eda9d13bc48521dd",
				measurementId: "G-0G25P8RGFW",
			};

			const app = initializeApp(firebaseConfig);
			const db = getDatabase(app);

			let roomId = null;
			let username = null;
			let playerKey = null;
			let playerList = []; // tableau global des joueurs

			// GÃ©nÃ¨re un code de room style LG-XXXXXX
			function generateRoomCode() {
				const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
				let code = "";
				for (let i = 0; i < 6; i++) {
					code += chars.charAt(Math.floor(Math.random() * chars.length));
				}
				return "LG-" + code;
			}

			// CrÃ©er une partie
			function createGame() {
				username = document.getElementById("username").value.trim();
				if (!username) return alert("Choisis un pseudo !");

				roomId = generateRoomCode();
				document.getElementById(
					"roomInfo"
				).innerHTML = `<b>Code de ta partie :</b> ${roomId}<br>Partage-le avec tes amis !`;

				joinRoom();
			}

			// Rejoindre une partie existante
			function joinGame() {
				username = document.getElementById("username").value.trim();
				roomId = document
					.getElementById("roomInput")
					.value.trim()
					.toUpperCase();
				if (!username || !roomId)
					return alert("Entre ton pseudo et un code de partie !");

				document.getElementById(
					"roomInfo"
				).innerHTML = `<b>Tu as rejoint la partie :</b> ${roomId}`;

				joinRoom();
			}

			function joinRoom() {
				const playersRef = ref(db, `rooms/${roomId}/players`);
				const newPlayer = push(playersRef);
				set(newPlayer, username);
				playerKey = newPlayer.key;

				// Stocker les joueurs dans un tableau + afficher
				onValue(playersRef, (snapshot) => {
					const players = snapshot.val() || {};
					playerList = Object.values(players);
					document.getElementById("players").innerHTML =
						playerList.join("<br>");
				});

				// Chat en live
				const chatRef = ref(db, `rooms/${roomId}/messages`);
				onChildAdded(chatRef, (snapshot) => {
					const msg = snapshot.val();
					const chatBox = document.getElementById("chat");
					chatBox.innerHTML += `<div><b>${msg.username}:</b> ${msg.message}</div>`;
					chatBox.scrollTop = chatBox.scrollHeight;
				});

				// Supprimer joueur Ã  la dÃ©connexion
				window.addEventListener("beforeunload", () => {
					if (playerKey) {
						remove(ref(db, `rooms/${roomId}/players/${playerKey}`));
					}
				});
			}

			// Envoyer message
			function sendMessage() {
				const message = document.getElementById("message").value.trim();
				if (!message || !username || !roomId) return;
				const chatRef = ref(db, `rooms/${roomId}/messages`);
				push(chatRef, { username, message });
				document.getElementById("message").value = "";
			}

			// Debug : afficher la liste en console
			function debugPlayers() {
				console.log("Liste actuelle des joueurs :", playerList);
			}

			// Rendre accessible depuis HTML
			window.createGame = createGame;
			window.joinGame = joinGame;
			window.sendMessage = sendMessage;
			window.debugPlayers = debugPlayers;
		</script>
	</body>
</html>
